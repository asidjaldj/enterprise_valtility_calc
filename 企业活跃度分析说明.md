# 主键

首先我们确认主键为`nbxh`内部序号，这是所提供的所有表中都有的列，代表了每个企业的编号。

# 查询当月成立企业

通过[主体登记表]()`clrq `成立日期字段来查询当月成立企业

# 查询当月注吊销及迁出企业

通过[主体登记表]()`tslx & hzrq`特殊类型及核准日期字段来查询当月注吊销及迁出企业

其中，注、吊销、迁出与`tslx`特殊类型字段的值有如下对应关系，

- 注销（07）
- 吊销（11）
- 迁出（13）

# 企业提取

每月收到的[主体登记表]()中包含自上世纪七八十年代以来所有企业，总计300万+企业，其中有不少企业都注销或吊销了。

我们进行如下操作

1. **提取当月注吊销企业： **依据相应字段提取当月注、吊销、迁出企业。将其中企业的经营状态更改为0，这些企业无论当月有什么活动，活跃度都为0。
2. **提取现存企业： **删除所有注吊销企业。将剩余企业的经营状态更改为1，这些企业的活跃度可计算。
3. **二者合并：**新表中既有到处[主体登记表]()当日的现存企业，又有当月注吊销企业

截止到这一步，我们就获得了当月所需要进行活跃度分析的企业。

## 重要列提取

- `jjhklb`经济户口类别：用于经济户口**分类**
- `nbxh`内部序号：索引
- `hydm`行业代码：用于行业和三次产业**分类**
- `djjg`登记机关：用于地区**分类**
- `zczb`注册资本：用于规模**分类**
- `jyzt`经营状态：0， 1
- `clrq`成立日期：用于存续时间**分类**
- `qylx(C|6)` 企业类型：用于决定哪些企业公积金为0

## 缺失值填补

提取出的列存在有缺失值的情况，按照如下规则进行填补

- `jjhklb`经济户口类别填补为众数
- `hydm`行业代码填补为众数
- `djjg`等级机关填补为临近值
- `zczb`注册资本填补为众数
- `clrq`成立日趋填补为众数

我们将这经过一系列操作后得到的表称为[主表]()，主表拥有180余万数据。

# 特征添加

| 特征编号 |         特征名称         | 权重  |
| :------: | :----------------------: | :---: |
|   X1_2   |     国税地税纳税状态     |  0.4  |
|    X3    |       社保缴存状态       | 0.15  |
|    X4    |      公积金缴存状态      | 0.15  |
|    X5    |     企业变更备案次数     | 0.05  |
|    X6    |    企业变更备案类别数    | 0.05  |
|    X7    |     分支机构开设数量     | 0.05  |
|    X8    |     对外投资企业个数     | 0.02  |
|    X9    |       对外投资总额       | 0.02  |
|   X10    |         投资次数         | 0.025 |
|   X11    |         投资总额         | 0.025 |
|   X12    |   投资资本类变更类型数   | 0.01  |
|   X13    |    投资资本类变更次数    | 0.01  |
|   X14    |       迁移申请次数       | 0.04  |
|   X15    |    分支机构注吊销数量    | -0.03 |
|   X16    |       欠缴社保月数       | -0.01 |
|   X17    |      欠缴公积金月数      | -0.01 |
|   X18    | 按企业全称搜索新闻结果数 | 0.05  |

可以提取到的特征如下，但并不是每个月都有这些特征

- X5
- X6
- X7
- X10
- X11
- X12
- X13
- X15

剩余无法提取的特征整列赋值

-----
- X1_2
- X3
- X4
这三列赋值为1，其中`X4 公积金缴存状态`较为特殊，由于没有数据为了硬凑，将企业类型为`1151 4540 2151`的公积金那里赋值为0， 
也就是这三个企业类型的企业注定不合格

-----
- X8
- X9
- X16
- X17    
这四列赋值为0
-----
- X18 `按企业全称搜索新闻结果数`较为特殊，将其随机赋值为0-9这10个数字，也是为了控制最后的得分，不然绝大多数企业的活跃度评分都是一样的。    
  **因为绝大多数企业是无法提取到特征的。**

## 可提取特征的提取方法说明

### X5，企业变更备案次数

来源于[变更情况表]()，只要对表中的`nbxh`内部序号进行统计，然后将次数按照主键加入进[主表]()中即可

***对缺失值填补为0***

### X6，企业变更备案类别数

来源于[变更情况表]()，

- 我们保留`nbxh &  bgsx`内部序号和变更事项列，按内部序号进行分组，也就是每个内部序号代表一个组，组内就是变更事项。
- 接下来我们统计组内每个变更事项出现的次数，从代码的角度讲这样做取index即可获得`nbxh-bgsx`对，截取`nbxh-bgsx`对中的nbxh统计个数即可获得X6特征。

按照主键加入进[主表]()即可。

***对缺失值填补为0***

### X7，分支机构开设数量

来源于[分支机构表]()，

- 我们统计`ENTNAME`列中每个值的统计数量即可，这个统计数量即为X7特征。

- 由于分支机构表的nbxh是分支机构的内部序号，我们通过企业名称匹配主体企业的内部序号。**并非所有企业名称都能找到相应的nbxh**

按照主键加入进[主表]()即可。

***对缺失值填补为0***

### X10，投资次数

来自[企业关系人表]()，

- `tznbxh & tze`投资内部序号和投资额有一个为空则删除
- 只要对表中的`tznbxh`内部序号进行统计，然后将次数按照主键加入进[主表]()中即可

***对缺失值填补为0***

### X11，投资总额

来自[企业关系人表]()，对`tznbxh`投资内部序号分组后，对`tze`投资额求和，（从代码来讲就是使用了groupby 和 agg函数），然后将求和结果按照主键加入进[主表]()中即可。

***对缺失值填补为0***

### X12，投资资本变更类型数

来源于[变更情况表]()，

- 保留变更事项与投资资本相关的行，即`bgsx`变更事项 ==120, 170, 700, 134, 118, 155, 117, 127, 136, 154, 914, 131, 923的列。
- 用提取X6的方法来提取类型数即可。

按照主键加入[主表]()即可。

***对缺失值填补为0***

### X13，投资资本变更次数



来源于[变更情况表]()，保留的企业与X12相同，处理方法与X5相同。

***对缺失值填补为0***

### X14，迁移申请次数

来源于[迁移信息表]()，此表中的`MARPRID`就是主表中的`nbxh`，对`MARPRID`进行统计，得到的统计值根据主键加入进[主表]()。

***对缺失值填补为0***

### X15，分支机构注吊销数量

来源于[变更情况表]()，查找`bgsx`变更事项列值为165的行，如果有则根据主键加入进[主表]()。

***对缺失值填补为0***

# 异常值处理&调节参数计算

## 异常值处理

- 计算每列均值（mean）和标准差（std）
- 计算每列的最大值（max）和最小值（min）
```python
min = np.array(mean) - 1.5 * np.array(std)
max = np.array(mean) + 1.5 * np.array(std)
```
- 将非0的数据标准化到`[min, max]`之间，也就是大于max的替换为max，小于min的替换为min

## 调节参数计算

- 行业调节参数计算(针对有值的指标进行调节参数计算)
```c
调节参数 = 指标均值 / 指标的分行业均值
```
- 规模调节参数计算(针对有值的指标进行调节参数计算)
```c
调节参数 = 指标均值 / 指标的分规模均值
```
------
两种调节参数计算完成后分别存为两个`csv`文件，方便后续读取和更改

## 归一化处理

**将数据处理为最小值为0，最大值为1的值**

伪代码
```python
for i in tqdm(feature_list):
    dc[i] = (dc[i] - dc[i].min())/ (dc[i].max() - dc[i].min())
```

# 活跃度计算

使用numpy向量按位相乘的方法     
共有**5**个规模**21**个行业，它们都有对应的调节参数，两种调节参数相乘后，分为***105***个类    
最后再与17个特征进行按位相乘，计算活跃度。

-----
活跃度计算完成后也不是按照“企业活跃度算法模型”来的，而是挑选一个能让整体活跃度>75%的一个值
```python
temp_EA75 = dc_2['EA'].describe()['25%']
# 大于该值的活跃度合格
# 小于该值的活跃度不合格
```

----
用最后得到的结果计算各分类的活跃度

# 分类结果说明

## 列名说明

在活跃度文件中`proportion`代表***活跃度***`sum`代表该行对应分类的***企业总数***

三次产业行业数量及占比中`num`代码***该行业数量***，`proportion`代表***该行业占该产业的比例***

## 产业对应

| three |   说明   |
| :---: | :------: |
|   1   | 第一产业 |
|   2   | 第二产业 |
|   3   | 第三产业 |

## 规模对应

| scale |      说明      |
| :---: | :------------: |
|   1   |   100 万以内   |
|   2   |  100-1000 万   |
|   3   | 1000-10000 万  |
|   4   | 10000-20000 万 |
|   5   |  20000万以上   |

##　行业对应

| *行业代码* (hydm) |             **说明**             |
| :---------------: | :------------------------------: |
|         A         |         农、林、牧、渔业         |
|         B         |              采矿业              |
|         C         |              制造业              |
|         D         | 电力、热力、燃气及水生产和供应业 |
|         E         |              建筑业              |
|         F         |           批发和零售业           |
|         G         |      交通运输、仓储和邮政业      |
|         H         |           住宿和餐饮业           |
|         I         |  信息传输、软件和信息技术服务业  |
|         J         |              金融业              |
|         K         |             房地产业             |
|         L         |         租赁和商务服务业         |
|         M         |       科学研究和技术服务业       |
|         N         |    水利、环境和公共设施管理业    |
|         O         |    居民服务、修理和其他服务业    |
|         P         |               教育               |
|         Q         |          卫生和社会工作          |
|         R         |        文化、体育和娱乐业        |
|         S         |   公共管理、社会保障和社会组织   |
|         T         |             国际组织             |
|         Z         |         其他类型经济组织         |

## 经济户口类别对应

| 经济户口 | 说明 |
| :------: | :--: |
|    1     | 内资 |
|    2     | 外资 |
|    3     | 私营 |

## 企业存续时间对应

| 年限类别 |   说明   |
| :------: | :------: |
|    1     | 1年以内  |
|    2     |  1-2年   |
|    3     |  2-3年   |
|    4     |  3-4年   |
|    5     |  4-5年   |
|    6     |  5-6年   |
|    7     |  6-7年   |
|    8     |  7-8年   |
|    9     |  8-9年   |
|    10    |  9-10年  |
|    11    | 大于10年 |

